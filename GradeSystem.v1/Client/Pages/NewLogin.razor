@page "/new_login"
@layout EmptyLayout
@using GradeSystem.v1.Client.Auth
@using GradeSystem.v1.Shared
@using System.Net
@inject HttpClient httpClient
@inject IJSRuntime js
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navMenager

<div style="display:flex; height:100vh;">
    <div style="width:50%;">
        <div style="display:flex;flex-direction:column; justify-content:center;align-items:center;height:100%;">
            <div class="form-group">
                <img src="Img/logo.png" style="height:10vh;width:10vh;" />
            </div>
            <div class="form-group">
                <h2 style="display:flex;justify-content:center;width:30vh;">Log in to your account</h2>
            </div>
            <RadzenTemplateForm TItem="LoginRequest" Data="loginRequest" Submit="HandleSubmit">
                <div class="form-group">
                    <RadzenTextBox @bind-Value="loginRequest.UserName" Placeholder="Username "Name="UserName" Style="width:30vh;"></RadzenTextBox>
                    <RadzenRequiredValidator Component="UserName" Text="Enter username" Popup="true" Style="display:block;"/>
                </div>
                <div class="form-group">
                    <RadzenPassword @bind-Value="loginRequest.Password" Placeholder="Password" Name="Password" Style="width:30vh;"></RadzenPassword>
                    <RadzenRequiredValidator Component="Password" Text="Enter password" Popup="true" Style="display:block;" />
                </div>
                <div class="form-group" style="display:flex;flex-direction:row; justify-content:space-between;">
                    <div style="display:flex;flex-direction:row;">
                        <RadzenCheckBox @bind-Value="loginRequest.RememberMe"  TValue="bool" Change="OnChange" Name="Checkbox" Style="margin-right:5px;"></RadzenCheckBox>
                        <RadzenLabel Text="Remember me" Component="Checkbox"  Style="font-weight:100;" />
                    </div>
                    <button style="background:none;border:0;text-decoration:underline;font-weight:100;cursor:pointer;">Forgot my password</button>
                </div>
                <div class="form-group">
                    <button class="rounded-filled-button" style="width:30vh;" type="submit">Log in</button>
                </div>
            </RadzenTemplateForm>
            <RadzenText Visible="@visibile">Wrong username or password</RadzenText>
        </div>
    </div>
    <div style="width:50%;">
        <div style="display:flex;align-items:center;justify-content:center; height:100%;">
            <img src="Img/student_debil.jpg" style="border-radius:10px; height:95%;width:95%;"/>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new LoginRequest();
    bool visibile = false;
    void OnChange(bool value)
    {
        loginRequest.RememberMe = value;
    }
    private async Task HandleSubmit()
    {
        var loginResponse = await httpClient.PostAsJsonAsync<LoginRequest>("/api/Account/Login", loginRequest);
        if (loginResponse.IsSuccessStatusCode)
        {
            var userSession = await loginResponse.Content.ReadFromJsonAsync<UserSession>();
            var customAuthStateprovider = (CustomAuthenticationStateProvider)authStateProvider;
            await customAuthStateprovider.UpdateAuthenticationState(userSession);
            navMenager.NavigateTo("/", true);
        }
        else if (loginResponse.StatusCode == HttpStatusCode.Unauthorized)
        {
            visibile = true;
            //await js.InvokeVoidAsync("alert", "Invalid Login or Password");
            //return;
        }

    }
}
